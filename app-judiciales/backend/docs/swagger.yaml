openapi: 3.0.3
info:
  title: Sistema de Expedientes Militares API
  description: |
    API REST para el sistema de gesti√≥n de expedientes militares
    
    ## Autenticaci√≥n
    
    Esta API utiliza autenticaci√≥n Bearer Token (JWT). Para usar los endpoints protegidos:
    
    1. **Primero, obt√©n un token** haciendo login en `/auth/login`
    2. **Autor√≠zate en Swagger UI** haciendo clic en el bot√≥n "Authorize" üîí arriba
    3. **Ingresa el token** en el formato: `Bearer tu_token_aqu√≠`
    4. **Haz clic en "Authorize"** y luego "Close"
    
    ### Ejemplo de autorizaci√≥n:
    ```
    Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    ```
    
    ### Credenciales por defecto:
    - **Email:** admin@sistema.mil
    - **Password:** admin123
    
    Una vez autorizado, podr√°s usar todos los endpoints protegidos.
  version: 1.0.0
  contact:
    name: Soporte API
    email: soporte@sistema.mil

servers:
  - url: http://localhost:8082/api/v1
    description: Servidor de desarrollo

tags:
  - name: Auth
    description: Autenticaci√≥n y autorizaci√≥n
  - name: Users
    description: Gesti√≥n de usuarios
  - name: Expedientes
    description: Gesti√≥n de expedientes militares
  - name: Dashboard
    description: Estad√≠sticas y m√©tricas del sistema
  - name: Profiles
    description: Gesti√≥n de perfiles y roles de usuario
  - name: Permissions
    description: Gesti√≥n de permisos del sistema
  - name: System
    description: Informaci√≥n del sistema

paths:
  /health:
    get:
      tags:
        - System
      summary: Health check del sistema
      description: Endpoint para verificar el estado del sistema. Disponible en `/api/v1/health`
      responses:
        '200':
          description: Servidor funcionando correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-11-05T09:16:19.0261846Z"
                  service:
                    type: string
                    example: "expedientes-backend"

  /auth/login:
    post:
      tags:
        - Auth
      summary: Iniciar sesi√≥n
      description: |
        Autentica un usuario y devuelve un token JWT.
        
        **Pasos para usar la API:**
        1. Usa este endpoint para obtener tu token
        2. Copia el token de la respuesta
        3. Haz clic en "Authorize" üîí arriba de esta p√°gina
        4. Pega el token en el campo (formato: `Bearer tu_token`)
        5. Ya puedes usar todos los endpoints protegidos
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: admin@sistema.mil
              password: admin123
      responses:
        '200':
          description: Login exitoso - Copia el token de la respuesta para autorizaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciales incorrectas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users:
    get:
      tags:
        - Users
      summary: Listar usuarios
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Users
      summary: Crear usuario
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - nombre
                - apellido
                - documento
                - password
                - profile_id
              properties:
                email:
                  type: string
                  format: email
                  example: usuario@sistema.mil
                nombre:
                  type: string
                  example: Juan
                apellido:
                  type: string
                  example: P√©rez
                documento:
                  type: string
                  example: 12345678
                password:
                  type: string
                  minLength: 8
                  example: password123
                profile_id:
                  type: string
                  example: 507f1f77bcf86cd799439011
      responses:
        '201':
          description: Usuario creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Obtener usuario por ID
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Usuario encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Users
      summary: Actualizar usuario
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                nombre:
                  type: string
                apellido:
                  type: string
                documento:
                  type: string
                activo:
                  type: boolean
      responses:
        '200':
          description: Usuario actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
      summary: Eliminar usuario
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Usuario eliminado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/profile:
    get:
      tags:
        - Users
      summary: Obtener perfil del usuario actual
      description: Obtiene la informaci√≥n del perfil del usuario autenticado
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Perfil del usuario actual
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Users
      summary: Actualizar perfil del usuario actual
      description: Permite al usuario actualizar su propia informaci√≥n de perfil
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nombre:
                  type: string
                  example: "Juan Carlos"
                apellido:
                  type: string
                  example: "P√©rez Garc√≠a"
                telefono:
                  type: string
                  example: "+591 70123456"
              example:
                nombre: "Juan Carlos"
                apellido: "P√©rez Garc√≠a"  
                telefono: "+591 70123456"
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
                    example: "perfil actualizado exitosamente"
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/password:
    put:
      tags:
        - Users
      summary: Cambiar contrase√±a del usuario actual
      description: Permite al usuario cambiar su propia contrase√±a
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - current_password
                - new_password
              properties:
                current_password:
                  type: string
                  example: "password123"
                  description: "Contrase√±a actual del usuario"
                new_password:
                  type: string
                  minLength: 8
                  example: "newPassword456"
                  description: "Nueva contrase√±a (m√≠nimo 8 caracteres)"
              example:
                current_password: "password123"
                new_password: "newPassword456"
      responses:
        '200':
          description: Contrase√±a actualizada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "contrase√±a actualizada exitosamente"
        '400':
          description: Error de validaci√≥n o contrase√±a actual incorrecta
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expedientes:
    get:
      tags:
        - Expedientes
      summary: Listar expedientes militares
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: grado
          in: query
          schema:
            type: string
            enum: [GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA]
        - name: situacion_militar
          in: query
          schema:
            type: string
            enum: [Actividad, Retiro]
        - name: estado
          in: query
          schema:
            type: string
            enum: [dentro, fuera]
      responses:
        '200':
          description: Lista de expedientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Expediente'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Expedientes
      summary: Crear expediente militar
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExpedienteRequest'
      responses:
        '201':
          description: Expediente creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Expediente'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expedientes/{id}:
    get:
      tags:
        - Expedientes
      summary: Obtener expediente por ID
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Expediente encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Expediente'
        '404':
          description: Expediente no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Expedientes
      summary: Actualizar expediente
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateExpedienteRequest'
      responses:
        '200':
          description: Expediente actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Expediente'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Expediente no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Expedientes
      summary: Eliminar expediente
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Expediente eliminado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Expediente no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expedientes/search:
    get:
      tags:
        - Expedientes
      summary: Buscar expedientes
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          description: T√©rmino de b√∫squeda
          schema:
            type: string
        - name: grado
          in: query
          schema:
            type: string
            enum: [GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA]
        - name: cip
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Resultados de b√∫squeda
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Expediente'

  /expedientes/bulk-import:
    post:
      tags:
        - Expedientes
      summary: Importaci√≥n masiva de expedientes desde Excel
      description: |
        Permite importar m√∫ltiples expedientes desde un archivo Excel (.xlsx o .xls).
        
        **Formato del archivo Excel:**
        - Primera fila debe contener los encabezados exactos: `Grado`, `CIP`, `ApellidosNombres`, `NumeroPaginas`
        - Valores v√°lidos para Grado: GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA
        - CIP debe ser √∫nico (no puede existir en la base de datos)
        - ApellidosNombres debe tener al menos 3 caracteres
        - NumeroPaginas debe ser un n√∫mero entero mayor a 0
        
        **Valores por defecto asignados:**
        - SituacionMilitar: "Actividad"
        - Estado: "dentro" 
        - Ubicacion: "Archivo Central"
        - Orden: Asignado autom√°ticamente
        
        **Restricciones:**
        - Tama√±o m√°ximo del archivo: 10MB
        - Solo archivos .xlsx o .xls
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Archivo Excel con los expedientes a importar
              required:
                - file
            example:
              file: "expedientes.xlsx"
      responses:
        '200':
          description: Importaci√≥n completada exitosamente (todos los registros importados)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/BulkImportResult'
                  message:
                    type: string
                    example: "Todos los expedientes fueron importados exitosamente."
        '206':
          description: Importaci√≥n parcial (algunos registros con errores)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/BulkImportResult'
                  message:
                    type: string
                    example: "Importaci√≥n parcial completada. Algunos registros tuvieron errores."
        '400':
          description: Error en la importaci√≥n (ning√∫n registro importado) o archivo inv√°lido
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  data:
                    $ref: '#/components/schemas/BulkImportResult'
                  message:
                    type: string
                    example: "No se pudieron importar expedientes. Revise los errores y corrija el archivo Excel."
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Sin permisos suficientes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /dashboard/stats:
    get:
      tags:
        - Dashboard
      summary: Obtener estad√≠sticas del dashboard (p√∫blico para pruebas)
      description: |
        Obtiene estad√≠sticas comprehensivas para el dashboard, incluyendo:
        - Resumen general (totales, porcentajes)
        - Estad√≠sticas por grado militar
        - Estad√≠sticas por estado (dentro/fuera)
        - Estad√≠sticas por situaci√≥n militar (actividad/retiro)
        - Estad√≠sticas por ubicaci√≥n (top 10)
        - Estad√≠sticas temporales (por mes/a√±o)
        
        **Nota:** Este endpoint est√° temporalmente disponible sin autenticaci√≥n para pruebas.
      responses:
        '200':
          description: Estad√≠sticas del dashboard obtenidas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Dashboard statistics retrieved successfully"
                  data:
                    $ref: '#/components/schemas/DashboardStats'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expedientes/dashboard/stats:
    get:
      tags:
        - Dashboard
        - Expedientes
      summary: Obtener estad√≠sticas completas del dashboard
      description: |
        Obtiene estad√≠sticas comprehensivas para el dashboard, incluyendo:
        - Resumen general (totales, porcentajes)
        - Estad√≠sticas por grado militar
        - Estad√≠sticas por estado (dentro/fuera)
        - Estad√≠sticas por situaci√≥n militar (actividad/retiro)
        - Estad√≠sticas por ubicaci√≥n (top 10)
        - Estad√≠sticas temporales (por mes/a√±o)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estad√≠sticas del dashboard obtenidas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Dashboard statistics retrieved successfully"
                  data:
                    $ref: '#/components/schemas/DashboardStats'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Sin permisos suficientes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /dashboard/stats:
    get:
      tags:
        - Dashboard
      summary: Obtener estad√≠sticas completas del dashboard
      description: |
        **Endpoint principal del dashboard** - Obtiene estad√≠sticas comprehensivas organizadas por categor√≠as:
        
        ### üìä **Resumen General**
        - Total de expedientes registrados
        - Distribuci√≥n por estado (dentro/fuera)
        - Distribuci√≥n por situaci√≥n militar (actividad/retiro)
        - Promedio de p√°ginas por expediente
        - Total de p√°ginas y ubicaciones √∫nicas
        
        ### üéñÔ∏è **Estad√≠sticas por Grado Militar**
        - Distribuci√≥n por cada uno de los 11 grados militares
        - Cantidad por estado y situaci√≥n militar para cada grado
        - Porcentajes relativos y total de p√°ginas
        
        ### üìç **Estad√≠sticas por Ubicaci√≥n**
        - Top 10 ubicaciones con mayor cantidad de expedientes
        - Distribuci√≥n porcentual por ubicaci√≥n
        
        ### üìÖ **Estad√≠sticas Temporales**
        - Registros por mes (√∫ltimos 12 meses)
        - Registros por a√±o
        - Tendencia mensual (creciente/decreciente/estable)
        - Registros de los √∫ltimos 30 d√≠as
        
        **Permisos requeridos:** PermissionExpedienteRead
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estad√≠sticas del dashboard obtenidas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Dashboard statistics retrieved successfully"
                  data:
                    $ref: '#/components/schemas/DashboardStats'
        '401':
          description: No autorizado - Token no v√°lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Acceso denegado - Sin permisos de lectura de expedientes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /profiles:
    get:
      tags:
        - Profiles
      summary: Listar perfiles del sistema
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de perfiles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Profile'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Profiles
      summary: Crear nuevo perfil
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProfileRequest'
            example:
              name: "Operador"
              slug: "operador"
              description: "Perfil para operadores del sistema"
              permissions:
                - resource: "expedientes"
                  action: "read"
                  description: "Leer expedientes"
                - resource: "expedientes"
                  action: "create"
                  description: "Crear expedientes"
      responses:
        '201':
          description: Perfil creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Profile'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: El slug del perfil ya existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /profiles/{id}:
    get:
      tags:
        - Profiles
      summary: Obtener perfil por ID
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "507f1f77bcf86cd799439011"
      responses:
        '200':
          description: Perfil encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Profile'
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Profiles
      summary: Actualizar perfil
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Operador Avanzado"
                description:
                  type: string
                  example: "Perfil para operadores con permisos extendidos"
                permissions:
                  type: array
                  items:
                    $ref: '#/components/schemas/Permission'
                active:
                  type: boolean
                  example: true
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Profile'
        '400':
          description: Error de validaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: No se puede modificar perfil del sistema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Profiles
      summary: Eliminar perfil
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Perfil eliminado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: No se puede eliminar perfil del sistema o perfil en uso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /profiles/{id}/permissions:
    get:
      tags:
        - Profiles
      summary: Obtener permisos de un perfil
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Lista de permisos del perfil
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'

    put:
      tags:
        - Profiles
      summary: Actualizar permisos de un perfil
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - permissions
              properties:
                permissions:
                  type: array
                  items:
                    $ref: '#/components/schemas/Permission'
              example:
                permissions:
                  - resource: "expedientes"
                    action: "read"
                    description: "Leer expedientes"
                  - resource: "expedientes"
                    action: "create"
                    description: "Crear expedientes"
                  - resource: "users"
                    action: "read"
                    description: "Leer usuarios"
      responses:
        '200':
          description: Permisos actualizados exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Profile'

  /permissions:
    get:
      tags:
        - Permissions
      summary: Listar todos los permisos disponibles
      description: Obtiene la lista completa de permisos disponibles en el sistema
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de permisos disponibles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      expedientes:
                        type: array
                        items:
                          type: string
                        example: ["read", "create", "update", "delete"]
                      users:
                        type: array
                        items:
                          type: string
                        example: ["read", "create", "update", "delete"]
                      profiles:
                        type: array
                        items:
                          type: string
                        example: ["read", "create", "update", "delete"]

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        nombre:
          type: string
        apellido:
          type: string
        documento:
          type: string
        activo:
          type: boolean
        profile_id:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Expediente:
      type: object
      properties:
        id:
          type: string
        grado:
          type: string
          enum: [GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA]
        apellidos_nombres:
          type: string
          minLength: 3
        numero_paginas:
          type: integer
          minimum: 1
        situacion_militar:
          type: string
          enum: [Actividad, Retiro]
        cip:
          type: string
        estado:
          type: string
          enum: [dentro, fuera]
        ubicacion:
          type: string
        fecha_registro:
          type: string
          format: date-time
        fecha_actualizacion:
          type: string
          format: date-time
        orden:
          type: integer
          minimum: 1
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string
        updated_by:
          type: string

    CreateExpedienteRequest:
      type: object
      required:
        - grado
        - apellidos_nombres
        - numero_paginas
        - situacion_militar
        - cip
        - ubicacion
        - orden
      properties:
        grado:
          type: string
          enum: [GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA]
        apellidos_nombres:
          type: string
          minLength: 3
        numero_paginas:
          type: integer
          minimum: 1
        situacion_militar:
          type: string
          enum: [Actividad, Retiro]
        cip:
          type: string
        ubicacion:
          type: string
        orden:
          type: integer
          minimum: 1

    UpdateExpedienteRequest:
      type: object
      properties:
        grado:
          type: string
          enum: [GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA]
        apellidos_nombres:
          type: string
          minLength: 3
        numero_paginas:
          type: integer
          minimum: 1
        situacion_militar:
          type: string
          enum: [Actividad, Retiro]
        cip:
          type: string
        estado:
          type: string
          enum: [dentro, fuera]
        ubicacion:
          type: string
        orden:
          type: integer
          minimum: 1

    Profile:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          minLength: 3
          maxLength: 100
        slug:
          type: string
        description:
          type: string
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
        active:
          type: boolean
        is_system:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Permission:
      type: object
      properties:
        resource:
          type: string
        action:
          type: string
        description:
          type: string

    CreateProfileRequest:
      type: object
      required:
        - name
        - slug
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
        slug:
          type: string
          minLength: 3
          maxLength: 50
        description:
          type: string
          maxLength: 500
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: admin@sistema.mil
          description: Email del usuario en el sistema
        password:
          type: string
          minLength: 8
          example: admin123
          description: Contrase√±a del usuario
      example:
        email: admin@sistema.mil
        password: admin123

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            access_token:
              type: string
              example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
              description: Token JWT para autenticaci√≥n (usar en header Authorization como 'Bearer {token}')
            refresh_token:
              type: string
              example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
              description: Token de renovaci√≥n
            expires_at:
              type: string
              format: date-time
              example: 2025-11-04T20:00:00Z
              description: Fecha y hora de expiraci√≥n del token

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Credenciales incorrectas"

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object

    UpdateProfileRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
        description:
          type: string
          maxLength: 500
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
        active:
          type: boolean

    UpdatePermissionsRequest:
      type: object
      required:
        - permissions
      properties:
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
          description: Lista completa de permisos para el perfil

    PermissionList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            expedientes: ["read", "create", "update", "delete"]
            users: ["read", "create", "update", "delete"]
            profiles: ["read", "create", "update", "delete"]

    ProfileWithStats:
      allOf:
        - $ref: '#/components/schemas/Profile'
        - type: object
          properties:
            user_count:
              type: integer
              description: N√∫mero de usuarios con este perfil
              example: 5
            can_delete:
              type: boolean
              description: Indica si el perfil puede ser eliminado
              example: true

    BulkImportResult:
      type: object
      description: Resultado de la importaci√≥n masiva de expedientes
      properties:
        total_procesados:
          type: integer
          description: N√∫mero total de registros procesados
          example: 10
        exitosos:
          type: integer
          description: N√∫mero de expedientes importados exitosamente
          example: 8
        fallidos:
          type: integer
          description: N√∫mero de registros con errores
          example: 2
        errores:
          type: array
          description: Lista de errores encontrados durante la importaci√≥n
          items:
            $ref: '#/components/schemas/BulkImportError'
        expedientes_creados:
          type: array
          description: IDs de los expedientes creados exitosamente
          items:
            type: string
            example: "507f1f77bcf86cd799439011"

    BulkImportError:
      type: object
      description: Error espec√≠fico durante la importaci√≥n masiva
      properties:
        fila:
          type: integer
          description: N√∫mero de fila donde ocurri√≥ el error (incluye encabezado)
          example: 3
        campo:
          type: string
          description: Campo donde ocurri√≥ el error
          example: "Grado"
        valor:
          type: string
          description: Valor que caus√≥ el error
          example: "INVALIDO"
        error:
          type: string
          description: Descripci√≥n del error
          example: "Grado debe ser uno de: GRAL, CRL, TTE CRL, MY, CAP, TTE, STTE, TCO, SSOO, EC, TROPA"
        registro:
          $ref: '#/components/schemas/BulkImportExpediente'

    BulkImportExpediente:
      type: object
      description: Registro de expediente desde Excel antes de procesamiento
      properties:
        grado:
          type: string
          description: Grado militar como aparece en Excel
          example: "GRAL"
        cip:
          type: string
          description: CIP como aparece en Excel
          example: "12345678"
        apellidos_nombres:
          type: string
          description: Apellidos y nombres como aparecen en Excel
          example: "Garc√≠a, Juan Carlos"
        numero_paginas:
          type: string
          description: N√∫mero de p√°ginas como aparece en Excel (string antes de validaci√≥n)
          example: "45"
        fila:
          type: integer
          description: N√∫mero de fila en el Excel
          example: 2

    # Dashboard Statistics Schemas
    DashboardStats:
      type: object
      description: Estad√≠sticas completas del dashboard
      properties:
        resumen_general:
          $ref: '#/components/schemas/ResumenGeneral'
        estadisticas_por_grado:
          type: array
          items:
            $ref: '#/components/schemas/GradoStats'
        estadisticas_por_estado:
          type: array
          items:
            $ref: '#/components/schemas/EstadoStats'
        estadisticas_por_situacion:
          type: array
          items:
            $ref: '#/components/schemas/SituacionStats'
        estadisticas_por_ubicacion:
          type: array
          items:
            $ref: '#/components/schemas/UbicacionStats'
        estadisticas_temporales:
          $ref: '#/components/schemas/EstadisticasTemporales'
        generado_en:
          type: string
          format: date-time
          description: Timestamp de cuando se generaron las estad√≠sticas
          example: "2025-11-05T10:30:00Z"

    ResumenGeneral:
      type: object
      description: Resumen general de estad√≠sticas
      properties:
        total_expedientes:
          type: integer
          description: Total de expedientes en el sistema
          example: 1250
        expedientes_dentro:
          type: integer
          description: Expedientes con estado "dentro"
          example: 890
        expedientes_fuera:
          type: integer
          description: Expedientes con estado "fuera"
          example: 360
        porcentaje_dentro:
          type: number
          format: float
          description: Porcentaje de expedientes "dentro"
          example: 71.2
        porcentaje_fuera:
          type: number
          format: float
          description: Porcentaje de expedientes "fuera"
          example: 28.8
        personal_actividad:
          type: integer
          description: Personal en situaci√≥n de actividad
          example: 950
        personal_retiro:
          type: integer
          description: Personal en situaci√≥n de retiro
          example: 300
        porcentaje_actividad:
          type: number
          format: float
          description: Porcentaje de personal en actividad
          example: 76.0
        porcentaje_retiro:
          type: number
          format: float
          description: Porcentaje de personal en retiro
          example: 24.0
        promedio_paginas_por_expediente:
          type: number
          format: float
          description: Promedio de p√°ginas por expediente
          example: 45.3
        total_paginas:
          type: integer
          description: Total de p√°ginas en todos los expedientes
          example: 56625
        ubicaciones_unicas:
          type: integer
          description: N√∫mero de ubicaciones √∫nicas
          example: 15

    GradoStats:
      type: object
      description: Estad√≠sticas por grado militar
      properties:
        grado:
          type: string
          enum: ["GRAL", "CRL", "TTE CRL", "MY", "CAP", "TTE", "STTE", "TCO", "SSOO", "EC", "TROPA"]
          description: Grado militar
          example: "CAP"
        total:
          type: integer
          description: Total de expedientes de este grado
          example: 150
        dentro:
          type: integer
          description: Expedientes "dentro" de este grado
          example: 120
        fuera:
          type: integer
          description: Expedientes "fuera" de este grado
          example: 30
        actividad:
          type: integer
          description: Personal en actividad de este grado
          example: 140
        retiro:
          type: integer
          description: Personal en retiro de este grado
          example: 10
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa este grado del total
          example: 12.0
        total_paginas:
          type: integer
          description: Total de p√°ginas de expedientes de este grado
          example: 6750

    EstadoStats:
      type: object
      description: Estad√≠sticas por estado
      properties:
        estado:
          type: string
          enum: ["dentro", "fuera"]
          description: Estado del expediente
          example: "dentro"
        total:
          type: integer
          description: Total de expedientes en este estado
          example: 890
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa este estado
          example: 71.2
        total_paginas:
          type: integer
          description: Total de p√°ginas en este estado
          example: 42500

    SituacionStats:
      type: object
      description: Estad√≠sticas por situaci√≥n militar
      properties:
        situacion:
          type: string
          enum: ["Actividad", "Retiro"]
          description: Situaci√≥n militar
          example: "Actividad"
        total:
          type: integer
          description: Total de personal en esta situaci√≥n
          example: 950
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa esta situaci√≥n
          example: 76.0
        total_paginas:
          type: integer
          description: Total de p√°ginas en esta situaci√≥n
          example: 45000

    UbicacionStats:
      type: object
      description: Estad√≠sticas por ubicaci√≥n
      properties:
        ubicacion:
          type: string
          description: Nombre de la ubicaci√≥n
          example: "Archivo Central"
        total:
          type: integer
          description: Total de expedientes en esta ubicaci√≥n
          example: 320
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa esta ubicaci√≥n
          example: 25.6
        total_paginas:
          type: integer
          description: Total de p√°ginas en esta ubicaci√≥n
          example: 14500

    EstadisticasTemporales:
      type: object
      description: Estad√≠sticas temporales
      properties:
        registros_por_mes:
          type: array
          items:
            $ref: '#/components/schemas/RegistroMensual'
          description: Registros por mes (√∫ltimos 12 meses)
        registros_por_ano:
          type: array
          items:
            $ref: '#/components/schemas/RegistroAnual'
          description: Registros por a√±o
        ultimos_30_dias:
          type: integer
          description: Registros creados en los √∫ltimos 30 d√≠as
          example: 45
        tendencia_mensual:
          type: string
          enum: ["creciente", "decreciente", "estable"]
          description: Tendencia de registros mensuales
          example: "creciente"

    RegistroMensual:
      type: object
      description: Estad√≠sticas mensuales
      properties:
        ano:
          type: integer
          description: A√±o
          example: 2025
        mes:
          type: integer
          description: Mes (1-12)
          example: 11
        mes_nombre:
          type: string
          description: Nombre del mes
          example: "Noviembre"
        total:
          type: integer
          description: Total de registros en este mes
          example: 85
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa este mes
          example: 8.5

    RegistroAnual:
      type: object
      description: Estad√≠sticas anuales
      properties:
        ano:
          type: integer
          description: A√±o
          example: 2025
        total:
          type: integer
          description: Total de registros en este a√±o
          example: 450
        porcentaje:
          type: number
          format: float
          description: Porcentaje que representa este a√±o
          example: 36.0
